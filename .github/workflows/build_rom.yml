name: NexDroid ROM Factory

on:
  repository_dispatch:
    types: [build_rom]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: ‚¨áÔ∏è Checkout Repo
        uses: actions/checkout@v4

      # -------------------------------------------------
      # Free disk space (CRITICAL for payload + super.img)
      # -------------------------------------------------
      - name: üóëÔ∏è Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      # -------------------------------------------------
      # Environment setup (MATCHES mod.sh REQUIREMENTS)
      # -------------------------------------------------
      - name: üõ†Ô∏è Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 python3-pip \
            zip unzip \
            aria2 jq \
            erofs-utils fuse3 \
            lz4 \
            openjdk-17-jdk \
            aapt apksigner

          # Optional tools dir safety
          mkdir -p bin
          chmod +x bin/* || true

      # -------------------------------------------------
      # Run Modder Engine
      # -------------------------------------------------
      - name: üöÄ Run Modder Engine
        id: build
        env:
          PIXELDRAIN_KEY: ${{ secrets.PIXELDRAIN_KEY }}
        run: |
          set -e
          bash mod.sh "${{ github.event.client_payload.rom_url }}" | tee build.log

          LINK=$(grep -oE "https://pixeldrain.com/u/[A-Za-z0-9]+" build.log | tail -n 1)

          if [ -z "$LINK" ]; then
            echo "‚ùå No download link found"
            exit 1
          fi

          echo "DOWNLOAD_LINK=$LINK" >> $GITHUB_ENV

      # -------------------------------------------------
      # Success notification
      # -------------------------------------------------
      - name: ‚úÖ Notify Success
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="‚úÖ *Build Complete!*%0A%0Aüì¶ [Download Here](${{ env.DOWNLOAD_LINK }})"

      # -------------------------------------------------
      # Failure debugging
      # -------------------------------------------------
      - name: üîç Dump Build Logs
        if: failure()
        run: |
          echo "::error::Build Failed"
          cat build.log || true

      - name: ‚ùå Notify Failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.CHAT_ID }} \
          -d text="‚ùå Build Failed! Check GitHub Actions logs."
