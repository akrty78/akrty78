name: NexDroid ROM Factory

on:
  repository_dispatch:
    types: [build_rom]

jobs:
  build:
    name: üèóÔ∏è Build ROM
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: ‚¨áÔ∏è Checkout Source
        uses: actions/checkout@v4

      # 1. CRITICAL: Frees up ~30GB of space so the build doesn't crash
      - name: üßπ Optimize Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: üõ†Ô∏è Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip zip unzip aria2 jq erofs-utils
          chmod +x bin/*

      - name: üöÄ Execute Modder Engine
        id: build
        env:
          # Pass secrets securely to the script
          PIXELDRAIN_KEY: ${{ secrets.PIXELDRAIN_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          # The script handles the build, upload, AND success notification
          # We pipe output to both console (tee) and file for logging
          bash mod.sh "${{ github.event.client_payload.rom_url }}" 2>&1 | tee build.log

      # --- ERROR HANDLING ---
      # Only runs if the previous step failed
      - name: üö® Notify Failure
        if: failure()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          # Capture the last 20 lines of the log for the error message
          ERROR_LOG=$(tail -n 20 build.log)
          
          # Send Professional Error Alert
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage \
          -d chat_id=${CHAT_ID} \
          -d parse_mode=Markdown \
          -d text="‚ùå *NexDroid Build Failed*
          
          ‚ö†Ô∏è _The build process encountered a critical error._
          
          üìã *Log Snippet:*
          \`\`\`
          $ERROR_LOG
          \`\`\`
          
          üîç Check GitHub Actions for full details."
      - name: Setup Baksmali
        run: |
            mkdir -p bin
            curl -L https://github.com/baksmali/smali/releases/download/3.0.9/baksmali-3.0.9-fat.jar
