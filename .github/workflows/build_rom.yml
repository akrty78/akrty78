name: NexDroid ROM Factory

on:
  repository_dispatch:
    types: [build_rom]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip zip unzip aria2 jq erofs-utils
          # Make sure binaries are executable
          chmod +x bin/*

      - name: ğŸš€ Run Modder Engine
        id: build
        # We perform the build and redirect output to build.log
        # We also force exit code 0 initially so we can check the log for the link
        run: |
          bash mod.sh "${{ github.event.client_payload.rom_url }}" > build.log 2>&1
          
          # Check if the build actually succeeded by looking for the link
          LINK=$(grep "https://pixeldrain.com" build.log | tail -n 1)
          
          if [ -z "$LINK" ]; then
            echo "âŒ No download link found. Build failed."
            exit 1
          fi

          echo "DOWNLOAD_LINK=$LINK" >> $GITHUB_ENV

      - name: âœ… Notify Success
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="âœ… *Build Complete!* %0A%0AğŸ“¦ [Download Here](${{ env.DOWNLOAD_LINK }}) %0A%0A_Flash this zip in TWRP or unzip for Fastboot._"

      # --- DEBUGGING SECTION ---
      
      - name: ğŸ” Show Error Logs
        if: failure()
        run: |
          echo "::error::Build Failed! Dumping logs below:"
          cat build.log

      - name: âŒ Notify Failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.CHAT_ID }} \
          -d text="âŒ Build Failed! I have printed the logs in the GitHub Actions tab. Go check them!"

          - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      # ğŸ‘‡ ADD THIS NEW STEP HERE ğŸ‘‡
      - name: ğŸ—‘ï¸ Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # This cleans up huge pre-installed apps to give us ~15GB extra space
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: ğŸ› ï¸ Setup Environment
        # ... (rest of your file)
