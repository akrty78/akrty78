name: NexDroid ROM Factory
on:
  repository_dispatch:
    types: [build_rom]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: { contents: write, actions: write }
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        run: |
          sudo apt-get update && sudo apt-get install -y python3 python3-pip zip unzip aria2 jq erofs-utils
          chmod +x bin/*
      - name: Run Factory
        id: build
        run: |
          bash mod.sh "${{ github.event.client_payload.rom_url }}" > build.log 2>&1
          LINK=$(grep "https://pixeldrain.com" build.log | tail -n 1)
          echo "DOWNLOAD_LINK=$LINK" >> $GITHUB_ENV
      - name: Success
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.CHAT_ID }} -d parse_mode=Markdown \
          -d text="‚úÖ *Build Complete!* %0A%0Aüì¶ [Download Here](${{ env.DOWNLOAD_LINK }})"
      - name: Failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.CHAT_ID }} -d text="‚ùå Build Failed! Check GitHub Actions."
