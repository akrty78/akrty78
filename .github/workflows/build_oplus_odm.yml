name: OPLUS ODM Builder
on:
  repository_dispatch:
    types: [build_oplus_odm]

jobs:
  patch-odm:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      OPLUS_URL: ${{ github.event.client_payload.oplus_url }}
      XIAOMI_URL: ${{ github.event.client_payload.xiaomi_url }}
      CHAT_ID: ${{ github.event.client_payload.chat_id }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}

    steps:
      - name: Free Disk Space
        run: |
          echo "::group::Disk before cleanup"
          df -h /
          echo "::endgroup::"
          # Remove heavy preinstalled software (~30GB freed)
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/powershell /usr/share/swift /usr/local/.ghcup \
            /usr/lib/jvm /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/go \
            /opt/hostedtoolcache/PyPy /opt/hostedtoolcache/Ruby \
            /usr/local/graalvm /usr/local/share/chromium 2>/dev/null || true
          sudo docker image prune --all --force 2>/dev/null || true
          sudo apt-get autoremove -y 2>/dev/null || true
          sudo apt-get clean 2>/dev/null || true
          echo "::group::Disk after cleanup"
          df -h /
          echo "::endgroup::"

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq python3 erofs-utils jq aria2 zip unzip p7zip-full curl git
          echo "✅ System dependencies installed"

      - name: Install payload-dumper-go
        run: |
          wget -q -O pd.tar.gz https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -xzf pd.tar.gz
          find . -type f -name "payload-dumper-go" -exec sudo mv {} /usr/local/bin/ \;
          sudo chmod +x /usr/local/bin/payload-dumper-go
          rm -f pd.tar.gz
          echo "✅ payload-dumper-go installed"

      - name: Install extract.erofs
        run: |
          EROFS_URL="https://github.com/sekaiacg/erofs-extract/releases/latest/download/extract.erofs-linux-x86_64"
          if curl -fsSL -o /usr/local/bin/extract.erofs "$EROFS_URL" 2>/dev/null; then
            sudo chmod +x /usr/local/bin/extract.erofs
            echo "✅ extract.erofs installed (pre-built)"
          else
            echo "⚠️ Pre-built not found, cloning and building..."
            git clone --depth 1 https://github.com/sekaiacg/erofs-extract.git /tmp/erofs_build
            cd /tmp/erofs_build
            make -j$(nproc) 2>/dev/null || true
            if [ -f "extract.erofs" ]; then
              sudo cp extract.erofs /usr/local/bin/
              sudo chmod +x /usr/local/bin/extract.erofs
              echo "✅ extract.erofs built from source"
            else
              echo "⚠️ extract.erofs build failed — will use fsck.erofs fallback"
            fi
            cd -
            rm -rf /tmp/erofs_build
          fi

      - name: Run OPLUS ODM Patcher
        run: |
          chmod +x oplus_odm_patcher.sh
          bash oplus_odm_patcher.sh "$OPLUS_URL" "$XIAOMI_URL"

      - name: Notify on Failure
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d parse_mode="Markdown" \
            -d text="❌ *ODM Patch Failed*%0A%0AThe GitHub Actions workflow encountered an error.%0ACheck the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})."
