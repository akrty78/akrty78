name: OPLUS-ODM-BUILDER

on:
  repository_dispatch:
    types: [build_oplus_odm]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            zip \
            unzip \
            aria2 \
            jq \
            wget \
            curl \
            e2fsprogs \
            erofs-utils \
            bc \
            file

      - name: Install payload-dumper-go
        run: |
          echo "Installing payload-dumper-go..."
          
          # Try nicholasgc repo first (maintained fork)
          LATEST=$(curl -s https://api.github.com/repos/nicholasgc/payload-dumper-go/releases/latest | jq -r '.tag_name' 2>/dev/null || echo "")
          
          if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
            # Fallback to ssut original
            LATEST=$(curl -s https://api.github.com/repos/ssut/payload-dumper-go/releases/latest | jq -r '.tag_name')
            REPO="ssut/payload-dumper-go"
          else
            REPO="nicholasgc/payload-dumper-go"
          fi
          
          echo "Downloading from $REPO version $LATEST"
          
          wget -q "https://github.com/$REPO/releases/download/${LATEST}/payload-dumper-go_${LATEST#v}_linux_amd64.tar.gz" -O pdg.tar.gz || {
            echo "Download failed, trying alternative..."
            wget -q "https://github.com/ssut/payload-dumper-go/releases/download/${LATEST}/payload-dumper-go_linux_amd64.tar.gz" -O pdg.tar.gz
          }
          
          tar xzf pdg.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/
          sudo chmod +x /usr/local/bin/payload-dumper-go
          rm -f pdg.tar.gz
          
          # Verify
          payload-dumper-go --help || payload-dumper-go -v || echo "payload-dumper-go installed"

      - name: Run OPLUS-ODM-BUILDER
        env:
          PIXELDRAIN_KEY: ${{ secrets.PIXELDRAIN_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ github.event.client_payload.chat_id }}
          REQUESTER_CHAT_ID: ${{ github.event.client_payload.chat_id }}
          OPLUS_URL: ${{ github.event.client_payload.oplus_url }}
          XIAOMI_URL: ${{ github.event.client_payload.xiaomi_url }}
        run: |
          chmod +x oplus_odm_patcher.sh
          sudo -E bash oplus_odm_patcher.sh "$OPLUS_URL" "$XIAOMI_URL"

      - name: Upload Artifact (Fallback)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: patched-odm-${{ github.run_number }}
          path: /tmp/oplus_odm_builder_*/patched_odm.img
          retention-days: 7
          if-no-files-found: ignore

      - name: Notify on Failure
        if: failure()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ github.event.client_payload.chat_id }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              -d parse_mode="Markdown" \
              -d text="‚ùå *OPLUS-ODM-BUILDER Failed*%0A%0AThe build encountered an error.%0A%0A[View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo rm -rf /tmp/oplus_odm_builder_* || true
